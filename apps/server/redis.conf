# ===== redis.conf - Firma Hukum PERARI - Optimized Configuration =====
# Version: Production-Ready
# Environment: Docker Container
# Use Case: API Caching + Session Storage

# ============================================================================
# NETWORKING (Docker Environment)
# ============================================================================

# Bind to all interfaces (required for Docker)
bind 0.0.0.0

# Disable protected mode (Docker handles security)
protected-mode no

# Redis port
port 6379

# TCP settings
tcp-backlog 511
tcp-keepalive 300
timeout 0

# ============================================================================
# SECURITY (âš ï¸ ENABLE FOR PRODUCTION)
# ============================================================================

# ðŸ”¥ UNCOMMENT THIS IN PRODUCTION:
# requirepass your-very-strong-redis-password-here

# Disable dangerous commands (PRODUCTION ONLY)
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""
# rename-command CONFIG "CONFIG_abc123xyz"

# ============================================================================
# MEMORY MANAGEMENT (Optimized for Caching)
# ============================================================================

# ðŸ”¥ ADJUST BASED ON YOUR SERVER:
# - Development/Small: 256mb
# - Medium Load: 512mb
# - High Load: 1gb
maxmemory 256mb

# Cache eviction policy (Best for API caching)
maxmemory-policy allkeys-lru

# LRU algorithm samples (higher = more accurate, slower)
maxmemory-samples 5

# ============================================================================
# PERSISTENCE (RDB + AOF for Durability)
# ============================================================================

# --- RDB Snapshots (Point-in-time backups) ---
save 900 1       # After 15 min if at least 1 key changed
save 300 10      # After 5 min if at least 10 keys changed
save 60 10000    # After 1 min if at least 10000 keys changed

dbfilename dump.rdb
rdbcompression yes
rdbchecksum yes
stop-writes-on-bgsave-error yes

# --- AOF (Append-Only File for durability) ---
appendonly yes
appendfilename "appendonly.aof"

# Sync strategy (everysec = good balance)
appendfsync everysec

# Don't block on BGSAVE/BGREWRITEAOF
no-appendfsync-on-rewrite no

# Auto rewrite when AOF grows too large
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Use hybrid RDB+AOF format (faster loading)
aof-use-rdb-preamble yes

# Data directory
dir /data

# ============================================================================
# LAZY FREEING (Better Performance)
# ============================================================================

lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# ============================================================================
# LOGGING
# ============================================================================

# Log level: debug, verbose, notice, warning
# ðŸ”¥ Development: notice | Production: warning
loglevel notice

# Log to stdout (Docker best practice)
logfile ""

# ============================================================================
# CLIENT LIMITS
# ============================================================================

# Maximum number of connected clients
maxclients 10000

# ============================================================================
# OPTIMIZATION (Data Structure Thresholds)
# ============================================================================

# Hash optimization (good for user sessions)
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List optimization (good for queues)
list-max-ziplist-size -2
list-compress-depth 0

# Set optimization
set-max-intset-entries 512

# Sorted set optimization (good for leaderboards)
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog sparse encoding
hll-sparse-max-bytes 3000

# Stream optimization
stream-node-max-bytes 4096
stream-node-max-entries 100

# ============================================================================
# ACTIVE DEFRAGMENTATION (Reduce Memory Fragmentation)
# ============================================================================

activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 5
active-defrag-cycle-max 75

# ============================================================================
# ADVANCED SETTINGS
# ============================================================================

# Disable Transparent Huge Pages warning
# (handled by Docker/host OS)
# warnings off

# Slow log (track slow commands > 10ms)
slowlog-log-slower-than 10000
slowlog-max-len 128

# ============================================================================
# REPLICATION (For High Availability - Optional)
# ============================================================================

# If this is a replica, uncomment:
# replicaof <master-ip> <master-port>

# Replica settings
replica-read-only yes
replica-serve-stale-data yes

# ============================================================================
# NOTES FOR DEPLOYMENT
# ============================================================================

# DEVELOPMENT:
# - Memory: 256mb
# - Security: No password (OK)
# - Logging: notice level
# - AOF: everysec

# STAGING:
# - Memory: 512mb
# - Security: requirepass recommended
# - Logging: notice level
# - AOF: everysec

# PRODUCTION:
# - Memory: 1gb+
# - Security: requirepass MANDATORY
# - Logging: warning level
# - AOF: everysec
# - Disable dangerous commands
# - Setup replication for HA

# ============================================================================
# MONITORING TIPS
# ============================================================================

# Check memory usage:
#   redis-cli INFO memory

# Check hit rate:
#   redis-cli INFO stats | grep keyspace

# Monitor slow queries:
#   redis-cli SLOWLOG GET 10

# Check connected clients:
#   redis-cli CLIENT LIST